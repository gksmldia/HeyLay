<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.planb.statics.dao.StaticsDAO">

	<select id="countTotalSaved" parameterType="int" resultType="int">
		SELECT COUNT (*) cnt 
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
	</select>
	
	<select id="countTodaySaved" parameterType="int" resultType="int">
		SELECT COUNT (*) cnt 
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
		AND TO_CHAR(reg_date, 'YYYY-MM-DD') = TO_CHAR(current_date, 'YYYY-MM-DD') 
	</select>
	
	<select id="countYesSaved" parameterType="int" resultType="int">
		SELECT COUNT (*) 
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
		AND TO_CHAR(reg_date, 'YYYY-MM-DD') = TO_CHAR(current_date - 1, 'YYYY-MM-DD')
	</select>
	
	<select id="countBeforeYesSaved" parameterType="int" resultType="int">
		SELECT COUNT (*) 
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
		AND TO_CHAR(reg_date, 'YYYY-MM-DD') = TO_CHAR(current_date - 2, 'YYYY-MM-DD')
	</select>
	
	<select id="selectLikeSource" parameterType="int" resultType="staticsVO">
		SELECT r.sourceName columnName, COUNT(r.sourceName) cnt, r.data 
		FROM (SELECT so.name as sourceName, so.logo_img AS data 
		FROM q_like l
		INNER JOIN q_contents co ON co.no = l.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no 
		WHERE l.member_no = #{ no }) r 
		GROUP BY r.sourceName, r.data  
		ORDER BY cnt DESC 
		LIMIT 10 
	</select>
	
	<select id="selectSavedMoreSaved" parameterType="int" resultType="staticsVO">
		SELECT c.title columnName, COUNT (*) cnt, im.url AS data 
		FROM q_contents_saved cs2 
		INNER JOIN q_contents c ON c.no = cs2.contents_no 
		INNER JOIN q_image im ON c.no = im.contents_no 
		WHERE cs2.member_no != #{ no }
		AND cs2.contents_no IN (SELECT cs.contents_no 
		FROM q_contents_saved cs, q_contents cc 
		WHERE cs.member_no = #{ no } 
		AND cs.contents_no = cc.no
		AND cc.ban = 'N' )
		GROUP BY cs2.no, c.no, im.no 
		ORDER BY cnt DESC 
		LIMIT 10 
	</select>
	
	<select id="selectSavedLessSaved" parameterType="int" resultType="staticsVO">
		SELECT c.title columnName, COUNT (*) cnt, im.url AS data 
		FROM q_contents_saved cs2 
		INNER JOIN q_contents c ON c.no = cs2.contents_no 
		INNER JOIN q_image im ON c.no = im.contents_no 
		WHERE cs2.member_no != #{ no }
		AND cs2.contents_no IN (SELECT cs.contents_no 
		FROM q_contents_saved cs, q_contents cc 
		WHERE cs.member_no = #{ no } 
		AND cs.contents_no = cc.no
		AND cc.ban = 'N' ) 
		GROUP BY cs2.no, c.no, im.no 
		ORDER BY cnt 
		LIMIT 10 
	</select>
	
	<select id="selectSavedLike" parameterType="int" resultType="staticsVO">
		SELECT c.title columnName, COUNT (*) cnt, im.url AS data 
		FROM q_like l
		INNER JOIN q_contents c ON c.no = l.contents_no 
		INNER JOIN q_image im ON c.no = im.contents_no 
		WHERE l.member_no != #{ no }
		AND l.contents_no IN (SELECT cs.contents_no 
		FROM q_contents_saved cs, q_contents cc 
		WHERE cs.member_no = #{ no } 
		AND cs.contents_no = cc.no
		AND cc.ban = 'N' ) 
		GROUP BY l.no, c.no, im.no 
		ORDER BY cnt DESC 
		LIMIT 10 
	</select>
	
	<select id="selectSavedMonth" parameterType="int" resultType="staticsVO">
		SELECT TO_CHAR(reg_date, 'MM') columnName, COUNT (*) cnt
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
		AND TO_CHAR(reg_date, 'YYYY') = TO_CHAR(current_date, 'YYYY')
		GROUP BY TO_CHAR(reg_date, 'MM')
		ORDER BY cnt DESC 
	</select>
	
	<select id="sumSavedMonth" parameterType="int" resultType="int">
		SELECT COALESCE(SUM(r.cnt), 0) 
		FROM (SELECT COUNT(*) cnt
		FROM q_contents_saved 
		WHERE member_no = #{ no } 
		AND EXTRACT(YEAR FROM reg_date)  = EXTRACT(YEAR FROM NOW()) 
		GROUP BY TO_CHAR(reg_date, 'YYYY-MM') ) r
	</select>
	
	
	<select id="selectSavedSource" parameterType="int" resultType="staticsVO">
		SELECT r.sourceName columnName, COUNT(r.sourceName) cnt 
		FROM (SELECT so.name as sourceName 
		FROM q_contents_saved cs 
		INNER JOIN q_contents co ON co.no = cs.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no 
		WHERE cs.member_no = #{ no }) r 
		GROUP BY r.sourceName 
		ORDER BY cnt DESC 
		LIMIT 5 
	</select>
	
	<select id="selectSavedSourceType" parameterType="int" resultType="staticsVO">
		SELECT r.dataType columnName, COUNT(r.dataType) cnt 
		FROM (SELECT dt.data_type as dataType 
		FROM q_contents_saved cs 
		INNER JOIN q_contents co ON co.no = cs.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no 
		INNER JOIN q_data_type dt ON dt.no = so.data_type 
		WHERE cs.member_no = #{ no }) r 
		GROUP BY r.dataType 
		ORDER BY cnt DESC 
		LIMIT 5 
	</select>
	
	<select id="selectLikeSourceType" parameterType="int" resultType="staticsVO">
		SELECT r.dataType columnName, COUNT(r.dataType) cnt 
		FROM (SELECT dt.data_type as dataType 
		FROM q_like l
		INNER JOIN q_contents co ON co.no = l.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no 
		INNER JOIN q_data_type dt ON dt.no = so.data_type 
		WHERE l.member_no = #{ no }) r 
		GROUP BY r.dataType 
		ORDER BY cnt DESC 
		LIMIT 5 
	</select>
	
    <select id="selectWordCloudList" parameterType="int" resultType="staticsVO">
		SELECT keyword as columnName, COUNT(keyword) as cnt 
			FROM Q_KEYWORDS
		WHERE MEMBER_NO = #{ memberNo }
		GROUP BY keyword
		ORDER BY cnt DESC 
	</select> 
	
	<select id="selectAllUserWordCloudList" parameterType="staticsVO" resultType="staticsVO">
		SELECT keyword as columnName, COUNT(keyword) as cnt 
		FROM Q_KEYWORDS
		GROUP BY keyword
		ORDER BY cnt DESC 
	</select>
	
	<select id="selectAllSavedSource" parameterType="int" resultType="staticsVO">
		SELECT r.sourceName columnName, COUNT(r.sourceName) cnt 
		FROM (SELECT so.name as sourceName 
		FROM q_contents_saved cs 
		INNER JOIN q_contents co ON co.no = cs.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no) r 
		GROUP BY r.sourceName 
		ORDER BY cnt DESC 
	</select>
	
	<select id="selectAllSourceType" parameterType="int" resultType="staticsVO">
		SELECT r.dataType columnName, COUNT(r.dataType) cnt 
		FROM (SELECT dt.data_type as dataType 
		FROM q_contents_saved cs 
		INNER JOIN q_contents co ON co.no = cs.contents_no 
		INNER JOIN q_source so ON so.no = co.source_no 
		INNER JOIN q_data_type dt ON dt.no = so.data_type) r 
		GROUP BY r.dataType 
		ORDER BY cnt DESC 
	</select>
	
	<!-- 회원 전체의 조회수가 높은 콘텐츠 가로형 막대 그래프  -->
	<select id="selectAllCntContents" parameterType="int" resultType="staticsVO">
      SELECT title as columnName, view_cnt as data, round((view_cnt / sum(view_cnt) over ())*100,2) as cnt
      FROM q_contents
      ORDER BY cnt DESC
      limit 5
	</select>
	
	<!-- 신규 가입 유저 수 확인 --> 
	<select id="selectNewUserCnt" resultType="int">
		SELECT COUNT(no) as cnt
			FROM Q_member
		where reg_date &gt; current_date - interval '1 day'
	</select>
	
	<!-- 오늘의 검색 횟수  --> 
	<select id="selectSerachToday" resultType="int">
		SELECT COUNT(keyword) as cnt
			FROM Q_keywords
		where reg_date &gt; current_date - interval '1 day'
	</select>
	
	<!-- 오늘의 인기 키워드  --> 
	<select id="selectPopularKeyword" resultType="String">
		SELECT keyword, COUNT(keyword) as cnt
			FROM Q_keywords
		where reg_date &gt; current_date - interval '1 day'
		group by keyword
		order by cnt desc
		limit 1
	</select>
	
	<!-- 오늘 저장된 컨텐츠  --> 
	<select id="selectSavedContent" resultType="int">
		SELECT COUNT(no) as cnt
			FROM Q_contents_saved
		where reg_date &gt; current_date - interval '1 day'
	</select>
	
	<!-- 회원 전체의 조회수가 높은 사이트  -->
	<select id="selectCiteContents" parameterType="int" resultType="staticsVO">
		SELECT qs.name as columnName, SUM(qc.view_cnt) as cnt
		FROM q_source qs
		INNER JOIN q_contents as qc on qc.source_no = qs.no
		where view_cnt > 0
		GROUP BY name
		ORDER BY cnt DESC
		Limit 5
	</select>
	
	<!-- 전체 키워드 랭킹 -->
	<select id="selectAllKeywordList" resultType="KeywordsVO">
		SELECT keyword, COUNT(keyword) as cnt
		FROM Q_KEYWORDS
		GROUP BY keyword
		ORDER BY cnt DESC 
		Limit 50
	</select>
	
</mapper>